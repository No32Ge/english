<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Sraian EN">
    <meta property="og:description" content="nothing beats Sraian English">
    <meta property="og:image" content="https://ge32english.com/ge32/labs/GeSeed/v1/res/icon.png">
    <meta property="og:url" content="https://ge32english.com/ge32/labs/GeSeed/v1/home.html">
    <meta property="og:type" content="website">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <title>Schala's Magic Book</title>
    <!-- 使用Bootstrap简化样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="icon" href="./res/img/png/icon.png">
    <link rel="stylesheet" href="./css/menu.css">
    <link rel="stylesheet" href="./css/addGram.css">
    <link rel="stylesheet" href="./css/addVocab.css">
    <link rel="stylesheet" href="./css/catalog.css">
    <link rel="stylesheet" href="./css/export.css">
    <link rel="stylesheet" href="./css/import.css">
    <link rel="stylesheet" href="./css/importFromJs.css">
    <link rel="stylesheet" href="./css/article/head.css">
    <link rel="stylesheet" href="./css/article/paragraph.css">
    <link rel="stylesheet" href="./css/article/chineseContent.css">
    <link rel="stylesheet" href="./css/common/speaker.css">
    <link rel="stylesheet" href="./css/common/delete.css">
    <link rel="stylesheet" href="./css/article/vocab-list.css">
    <link rel="stylesheet" href="./css/article//grammer.css">
    <link rel="stylesheet" href="./css/article/englishText.css">
    <link rel="stylesheet" href="./css/page/container.css">
</head>

<body>

    <div class="container" id='Sraian'>
        <!-- <div class="bg"></div> -->
        <div class="header">
            <h1 id="page-title">Sraian阅读器</h1>
            <div class="info-bar" id="info-area">
                <!-- 信息将通过JavaScript动态生成 -->
            </div>
        </div>
        <div class="content" id="content-area">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>
        <div class="footer">
            <p>Created by Lil Geos | Spotlight 0.1</p>
        </div>
    </div>
    <div class="word-tooltip" id="word-tooltip"></div>
    <!-- 工具提示容器 -->
    <div id="slot-tooltip" class="slot-tooltip"></div>
    <script>
        console.log("b21")
        const contentArea = document.getElementById("content-area");
        // 中英文内容
        const texts = {
            en: {
                name: "Name: Spotlight",
                author: "Author: Ge32 (Yu Jian)",
                purpose: "Purpose: Learn English",
                version: "Version: 2.1",
                description: "",
                where: "log:"
            },
            zh: {
                name: "功能测试",
                author: "作者：Ge32（余健）",
                purpose: "用途：学英语",
                version: "版本：2.1",
                description: "",
                where: "日志:"
            }
        };
        // 检测浏览器语言
        const lang = navigator.language.startsWith("zh") ? "zh" : "en";
        const t = texts[lang];
        // 渲染
        contentArea.innerHTML = `
        <div style="margin-bottom:4px;">${t.name}</div>
        <div style="margin-bottom:4px;">${t.author}</div>
        <div style="margin-bottom:4px;">${t.purpose}</div>
        <div style="margin-bottom:4px;">${t.version}</div>
        <div style="margin-bottom:4px;">${t.description}
            <div id="where" style="margin-top:2px;">${t.where}</div>
        </div>
    `;
    </script>
    <script>
        
        const logs = [];
        function logStep(msg) {
            logs.push(msg);
            document.getElementById("where").innerHTML = logs.map((e, i) => `<div>${i} ${e}</div>`).join("");
        }
        document.addEventListener('initStep', e => logStep(e.detail));
    </script>
    <script type="module" src="./main.js"></script>

    <script>
        (async function () {
            // 1. 拉取远程版本号（强制不缓存）
            let remoteConfig = null;
            try {
                const res = await fetch(`/version.json?t=${Date.now()}`);
                remoteConfig = await res.json();
            } catch (e) {
                console.warn("version.json 加载失败");
            }
            if (!remoteConfig) return;

            const localVersion = localStorage.getItem('appVersion');

            // 2. 注册 SW
            if (!('serviceWorker' in navigator)) return;

            try {
                const reg = await navigator.serviceWorker.register('/service-worker.js');

                // 封装：向 SW 发送配置
                function sendConfig() {
                    if (reg.active) {
                        reg.active.postMessage({
                            type: 'SET_CONFIG',
                            payload: remoteConfig
                        });
                    }
                }

                // 情况 1：SW 一开始就已经 active
                if (reg.active) sendConfig();

                // 情况 2：SW 还没 active（安装中）
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated') {
                            sendConfig();
                            // 只在 SW 激活时 reload 一次
                            location.reload();
                        }
                    });
                });

                // 3. 版本号对比（只触发一次 reload）
                if (remoteConfig.version !== localVersion) {
                    console.log(`Version updated: ${localVersion} -> ${remoteConfig.version}`);
                    localStorage.setItem('appVersion', remoteConfig.version);
                    // 给 SW 留时间处理消息
                    setTimeout(() => location.reload(), 300);
                }

            } catch (error) {
                console.error('SW registration failed:', error);
            }
        })();
    </script>


    </script>
</body>

</html>